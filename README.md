# Проект Архитектуры с Docker Compose

Этот проект использует Docker Compose для разворачивания много-компонентного окружения, включающего веб-сервер, PHP-приложение, распределённую базу данных, очередь сообщений, кэш, NoSQL, Elasticsearch с Kibana и другие сервисы. Ниже описаны основные компоненты и их назначение.

## Стек и основные сервисы

- **server (nginx)**
    - Используется официальный образ `nginx:alpine`.
    - Выполняет роль обратного прокси-сервера.
    - Монтирует конфигурационные файлы, SSL-сертификаты и основной конфиг nginx из локальных директорий.
    - Прокидывает порты 80 (HTTP) и 443 (HTTPS).

- **webapp (PHP-приложение)**
    - Собирается на основе Dockerfile, расположенного по пути `./config/infrastructure/php/Dockerfile`.
    - Использует переменные окружения, в том числе настройки для подключения к БД (используется Citus).
    - Монтирует локальный код в контейнер, а также конфигурационные файлы PHP и Blackfire.
    - Зависит от сервисов `citus-coordinator` и `rabbitmq`.

- **citus-coordinator и citus-worker (PostgreSQL + Citus)**
    - **citus-coordinator**: основной координатор для распределённой БД.
    - **citus-worker-1 и citus-worker-2**: воркеры для распределённого хранения и обработки данных.
    - Используются образы `citusdata/citus:12.1.3`.
    - Позволяют горизонтально масштабировать PostgreSQL с помощью расширения Citus.

- **rabbitmq**
    - Образ: `rabbitmq:3.12-management`.
    - Управляет очередями сообщений для асинхронной обработки задач.
    - Прокидывает порты 5672 (AMQP) и 15672 (интерфейс управления).

- **mongodb**
    - Образ: `mongo:6.0`.
    - NoSQL база данных для хранения документов.
    - Настроен с корневым пользователем и паролем, порт 27017 открыт для доступа.

- **node_container**
    - Собирается на основе Dockerfile в директории `./frontend`.
    - Выполняет сборку и запуск frontend-приложения (npm run dev и node server.js).
    - Монтирует исходный код фронтенда для разработки.
    - Прокидывает порт 3005, связанный с приложением внутри контейнера.

- **blackfire**
    - Образ: `blackfire/blackfire`.
    - Инструмент для профилирования и мониторинга производительности PHP-приложения.
    - Использует переменные окружения для аутентификации.

- **jmeter**
    - Образ: `justb4/jmeter:latest`.
    - Используется для нагрузочного тестирования.
    - Монтируются директории с тестовыми планами (`.jmx` файлы) и логами тестирования.

- **redis**
    - Образ: `redis:7-alpine`.
    - Служит для кэширования и быстрого доступа к данным.
    - Прокидывается порт 6379.

- **elasticsearch**
    - Образ: `docker.elastic.co/elasticsearch/elasticsearch:8.11.1`.
    - Используется как поисковый движок и бекенд для логирования.
    - Запущен в однокластерном режиме (`discovery.type=single-node`).
    - Память ограничена с помощью ES_JAVA_OPTS.

- **kibana**
    - Образ: `docker.elastic.co/kibana/kibana:8.11.1`.
    - Веб-интерфейс для визуализации и анализа данных Elasticsearch.
    - Подключается к Elasticsearch через переменную окружения `ELASTICSEARCH_HOSTS`.

## Сети и тома

- **Сеть `architecht_network`**
    - Все сервисы подключены к общей внешней сети `architecht_network` для взаимодействия.

- **Тома для персистентных данных**
    - `citus_coordinator_data` — данные PostgreSQL (Citus Coordinator).
    - `rabbitmq_data` — данные RabbitMQ.
    - `mongodb_data` — данные MongoDB.
    - `esdata` — данные Elasticsearch.
    - Другие тома используются для node_modules (если необходимо).

## Как запустить

1. **Убедитесь, что Docker и Docker Compose установлены** на вашей машине.

2. **Настройте переменные окружения** в файле `.env.local` (если они требуются).

3. **Запустите Docker Compose:**

   ```bash
   docker-compose up -d
Проверьте статус контейнеров:

bash
Копировать
docker-compose ps
Доступ к сервисам:

Веб-приложение будет доступно через nginx по портам 80 и 443.

Kibana доступна по адресу http://localhost:5601.

RabbitMQ интерфейс управления доступен по адресу http://localhost:15672 (логин/пароль: guest/guest).

Что добавлено
NGINX как обратный прокси для распределения входящих запросов между сервисами.

PHP-приложение с поддержкой Blackfire для профилирования.

Распределённая база данных на основе Citus для горизонтального масштабирования PostgreSQL.

RabbitMQ для асинхронной обработки сообщений.

MongoDB для NoSQL-хранения данных.

Node.js контейнер для фронтенд разработки и сборки.

JMeter для нагрузочного тестирования.

Redis для кэширования.

Elasticsearch и Kibana для логирования и анализа данных.

Заключение
Этот стек позволяет разрабатывать, тестировать и масштабировать веб-приложение с использованием современных инструментов и технологий. Каждая часть окружения изолирована в контейнере, что упрощает управление зависимостями и обеспечивает гибкость при развертывании.